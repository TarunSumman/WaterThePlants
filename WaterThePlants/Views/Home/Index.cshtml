@model  List<WaterThePlants.Models.PlantModel>
@{
    ViewBag.Title = "Water Plants Real Time";
}
<style>
    div.clear
{
    clear: both;
}

div.plant-chooser{
    
}

    div.plant-chooser.disabled div.plant-chooser-item
	{
		zoom: 1;
		filter: alpha(opacity=60);
		opacity: 0.6;
		cursor: default;
	}

	div.plant-chooser div.plant-chooser-item{
		padding: 11px;
		border-radius: 6px;
		cursor: pointer;
		position: relative;
		border: 1px solid #efefef;
		margin-bottom: 10px;
        margin-left: 10px;
        margin-right: 10px;
	}
	
	div.plant-chooser div.plant-chooser-item.selected{
		border: 4px solid #428bca;
		background: #efefef;
		padding: 8px;
		filter: alpha(opacity=100);
		opacity: 1;
	}
		div.plant-chooser div.plant-chooser-item.disabled{
            cursor: not-allowed;
            pointer-events: all !important;
	}
		div.plant-chooser div.plant-chooser-item img{
			padding: 0;
		}
		
		div.plant-chooser div.plant-chooser-item span.title{
			display: block;
			margin: 10px 0 5px 0;
			font-weight: bold;
			font-size: 12px;
		}
		
		div.plant-chooser div.plant-chooser-item span.description{
			font-size: 12px;
		}
		
		div.plant-chooser div.plant-chooser-item input{
			position: absolute;
			left: 0;
			top: 0;
			visibility:hidden;
		}
</style>

<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
@section scripts {
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            // Declare a proxy to NotifyAllUsersHub the hub.
            var notify = $.connection.notifyAllUsersHub;

            notify.client.OnReminder = function (plantID) {
                $('#status_' + plantID).html('<span class="label label-danger">Plant is dying requires water</span>');
            }
            
            notify.client.OnHoldPlants = function (plantID) {
                for (i = 0; i < plantID.length; i++) {
                    //text += plantID[i] + "<br>";
                    $('#status_' + plantID[i]).html('<span class="label label-warning">On Hold : Someone else is Watering </span>');
                    $('#plant' + plantID[i]).addClass('disabled').removeClass('selected');;
                }
            }

            notify.client.OnUnHoldPlants = function (plantID) {
                for (i = 0; i < plantID.length; i++) {
                    //text += plantID[i] + "<br>";
                    $('#status_' + plantID[i]).html('<span class="label label-info">Free for water </span>');
                    $('#plant' + plantID[i]).removeClass('disabled');
                }
            }

            notify.client.OnCompleteWateringPlants = function (plantID) {
                $.each(plantID, function (v, i) {
                    var counter = 30;
                    $('#plant' + i).addClass('disabled').removeClass('selected');
                    var interval = setInterval(function () {
                        counter--;
                        // Display 'counter' wherever you want to display it.
                        if (counter <= 0) {
                            clearInterval(interval);
                            $('#plant' + i).removeClass('disabled');
                            $('#status_' + i).html('<span class="label label-info">Free for water </span>');
                            $('#plant' + i + ' .description').html('<strong>Last Watered : </strong>just now');
                            $.ajax({
                                url: '/Home/CompleteWateringPlants',
                                dataType: 'json',
                                type: 'GET',
                                data: { plantId: i },
                                traditional: true,
                                success: function (data) {
                                }
                            });
                            return;
                        } else {
                            $('#status_' + i).html('<span class="label label-default">To water the plant please wait for ' + counter + ' secs</span>');
                        }
                    }, 1000);
                });
            }
            // Start the connection.
            $.connection.hub.start().done(function () {
            }).fail(function (e) {
                alert(e);
            });

        });
    </script>
}
<script>
    $(function () {

        LoadPlantsLayout();

        var IsStarted = false;
        var interval;
        $('#WaterPlantBtn').on('click', function () {
            clearInterval(interval);
            if ($('#plantContainer').find('.selected').length === 0 && !IsStarted) {
                alert('Please Select a plant');
                return;
            }
            IsStarted = !IsStarted;
            if (IsStarted) {
                $(this).val('Stop Watering').removeClass().addClass('btn btn-danger');
                $("#hold-info").show();
            }
            else {
                $(this).val('Start Watering').removeClass().addClass('btn btn-info');
                $("#hold-info").hide();
            }
            if (IsStarted) {
                var arr = [];
                $('.selected').each(function (i, obj) {
                    var elem = $(this).attr('id');

                    arr.push(parseInt(elem.toString().replace('plant', '')));
                });
                $.ajax({
                    url: '/Home/HoldWatering',
                    dataType: 'json',
                    type: 'GET',
                    data: { plantId: arr },
                    traditional: true,
                    async: false,
                    success: function (data) {
                        if (data == "true") {
                            interval =  setTimeout(function () {
                                if (IsStarted) {
                                    $.ajax({
                                        url: '/Home/HoldReWateringPlants',
                                        dataType: 'json',
                                        type: 'GET',
                                        data: { plantId: arr },
                                        traditional: true,
                                        success: function (data) {
                                            $("#WaterPlantBtn").val('Start Watering').removeClass().addClass('btn btn-info');
                                            $("#hold-info").hide();
                                        }
                                    });
                                }
                            }, 10000);
                        }
                    },
                    error: function (data) {
                        console.log(data);
                    }
                });
            }
            else {
                var arr = [];
                $('.disabled').each(function (i, obj) {
                    var elem = $(this).attr('id');

                    arr.push(parseInt(elem.toString().replace('plant', '')));
                });
                $.ajax({
                    url: '/Home/UnHoldWatering',
                    dataType: 'json',
                    type: 'GET',
                    data: { plantId: arr },
                    traditional: true,
                    success: function (data) {
                        //LoadPlantsLayout();
                    }
                });
            }
        });

    });
    function LoadPlantsLayout() {
        $.ajax({
            url: '/Home/GetPlantList',
            dataType: 'json',
            type: 'GET',
            success: function (data) {
                var _html = '';
                $.each(data, function (v, i) {
                    var TimeLeft = parseInt(i.TimeLeft);
                    var IsDisabled = '';
                    var statusHtml = '';
                    if (i.Status == "H") {
                        IsDisabled = 'disabled';
                        statusHtml = '<span class="label label-warning">On Hold : Someone else is watering!! </span>';
                    }
                    else if (i.Status == "W") {
                        statusHtml = '<span class="label label-info">Free for water </span>';
                    }
                    else if (i.Status == "E") {
                        statusHtml = '<span class="label label-danger">Plant is dying requires water</span>';
                    }

                    else if (i.Status == "R") {
                        IsDisabled = 'disabled';
                        var counter = TimeLeft;
                        var interval = setInterval(function () {
                            counter--;
                            // Display 'counter' wherever you want to display it.
                            if (counter <= 0) {
                                clearInterval(interval);
                                $('#plant' + i.PlantID).removeClass('disabled');
                                $('#status_' + i.PlantID).html('<span class="label label-info">Free for water </span>');
                                return;
                            } else {
                                $('#status_' + i.PlantID).html('<span class="label label-info">Free for water </span>');
                            }
                        }, 1000);
                    }
                    var plantID = '\'plant' + i.PlantID + '\'';
                    _html += '<div class ="col-xs-12 col-sm-12 col-md-4 col-lg-4">' +
                                        '<div class ="plant-chooser-item ' + IsDisabled + '" id=' + plantID + '>' +
                                           ' <img src="https://hips.hearstapps.com/vader-prod.s3.amazonaws.com/1557258847-chinese-evergreen-houseplant-1557258690.jpg?crop=0.883xw:0.887xh;0.0849xw,0.0821xh&resize=480:*" class ="img-rounded col-xs-4 col-sm-4 col-md-12 col-lg-12" alt="Mobile and Desktop">' +
                                            '<div class ="col-xs-8 col-sm-8 col-md-12 col-lg-12">' +
                                              ' <span class ="title" ><h3> ' + i.PlantName + '</h3></span>' +
                                               '  <span class ="description" ><strong>Last Watered : </strong>' + i.LastWateredTime + '</span><br>' +
                                               ' <div class="status" id=' + 'status_' + i.PlantID + '>' + statusHtml + '</div>' +
                                           ' </div>' +
                                           ' <div class ="clear"></div>' +
                                       ' </div>' +
                                   ' </div>';

                })
                $("#plantContainer").append(_html);

                $('div.plant-chooser-item').on('click', function () {
                    if (!$(this).hasClass('disabled')) {

                        if ($(this).hasClass('selected')) {
                            $(this).removeClass('selected');
                        }
                        else {
                            $(this).addClass('selected');
                        }
                    }
                });
            },
            error: function (data) {
                console.log(data);
            }
        });
    }
</script>
<div class="container">
        <h2>Water The Plants Remotely</h2>
        <input type="button" id="WaterPlantBtn" class="btn btn-info" value="Start Watering">
        <span id="hold-info" class="text-warning" style="display:none">It gonna take 10 seconds</span>
        <br /><br />
        <div class="row form-group plant-chooser" id="plantContainer">

        </div>
</div>
